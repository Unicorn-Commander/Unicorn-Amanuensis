======================================================================
MEL INT8 NPU Kernel - Complete Build Pipeline
======================================================================

Step 1: Clean build directory...
✅ Build directory cleaned

Step 2: Compile INT8 optimized kernel to AIE2 ELF...
clang++: warning: treating 'c' input as 'c++' when in C++ mode, this behavior is deprecated [-Wdeprecated]
✅ AIE2 ELF compiled: 6976 bytes
   Kernel: INT8 optimized mel spectrogram (Q7 format)
   Features: FFT-512, 80 mel bins, SIMD vectorization

Step 3: Phase 1 - MLIR Lowering (aie-opt)...
✅ Device canonicalized: 4728 bytes

Step 4: Phase 3 - NPU Instruction Generation...
✅ NPU instructions generated: 0 bytes

Step 5: Phase 4 - CDO Generation...
✅ CDO generation command executed
Checking for generated CDO files...
✅ CDO files found:
-rw-rw-r-- 1 ucadmin ucadmin 204 Oct 28 01:00 main_aie_cdo_elfs.bin
-rw-rw-r-- 1 ucadmin ucadmin  44 Oct 28 01:00 main_aie_cdo_enable.bin
-rw-rw-r-- 1 ucadmin ucadmin 936 Oct 28 01:00 main_aie_cdo_init.bin
-rw-rw-r-- 1 ucadmin ucadmin 204 Oct 27 20:59 test_aie_cdo_elfs.bin
-rw-rw-r-- 1 ucadmin ucadmin  44 Oct 27 20:59 test_aie_cdo_enable.bin
-rw-rw-r-- 1 ucadmin ucadmin 936 Oct 27 20:59 test_aie_cdo_init.bin
  Renamed/copied main_aie_cdo_elfs.bin -> mel_aie_cdo_elfs.bin
  Renamed/copied main_aie_cdo_enable.bin -> mel_aie_cdo_enable.bin
  Renamed/copied main_aie_cdo_init.bin -> mel_aie_cdo_init.bin

Step 6: Creating bootgen BIF file...
✅ BIF file created

Step 7: Phase 5 - PDI Generation (bootgen)...


****** Bootgen v2023.2
  **** Build date : Oct 26 2025-02:48:38
    ** Copyright 1986-2022 Xilinx, Inc. All Rights Reserved.
    ** Copyright 2022-2023 Advanced Micro Devices, Inc. All Rights Reserved.


[INFO]   : Bootimage generated successfully

✅ PDI generated: 1280 bytes

Step 8: Updating AIE partition JSON with PDI filename...
✅ PDI copied with UUID filename: 87654321-4321-8765-4321-876543218765.pdi
✅ AIE partition updated with UUID-based PDI reference
✅ Metadata files prepared

Step 9: Phase 6 - XCLBIN Packaging with metadata...
   CRITICAL: Including EMBEDDED_METADATA (required for XRT DPU recognition)
XRT Build Version: 2.20.0 (HEAD)
       Build Date: 2025-10-08 06:49:15
          Hash ID: 9b916190ad2865a7e7e497155c66b3b4940f0add
Creating a default 'in-memory' xclbin image.

Section: 'MEM_TOPOLOGY'(6) was successfully added.
Size   : 88 bytes
Format : JSON
File   : 'mem_topology_mel.json'

Section: 'AIE_PARTITION'(32) was successfully added.
Size   : 1704 bytes
Format : JSON
File   : 'aie_partition_mel.json'

Section: 'EMBEDDED_METADATA'(2) was successfully added.
Size   : 974 bytes
Format : RAW
File   : 'embedded_metadata.xml'

Section: 'IP_LAYOUT'(8) was successfully added.
Size   : 88 bytes
Format : JSON
File   : 'ip_layout_mel.json'

Section: 'CONNECTIVITY'(7) was successfully added.
Size   : 40 bytes
Format : JSON
File   : 'connectivity_mel.json'

Section: 'GROUP_CONNECTIVITY'(27) was successfully added.
Size   : 76 bytes
Format : JSON
File   : 'group_connectivity_mel.json'

Section: 'GROUP_TOPOLOGY'(26) was successfully added.
Size   : 88 bytes
Format : JSON
File   : 'group_topology.json'
Successfully wrote (6753 bytes) to the output file: mel_int8_final.xclbin
Leaving xclbinutil.
✅ XCLBIN packaged with metadata: 6753 bytes
   Sections: MEM_TOPOLOGY, AIE_PARTITION, EMBEDDED_METADATA (✅),
             IP_LAYOUT, CONNECTIVITY, GROUP_CONNECTIVITY, GROUP_TOPOLOGY

Step 10: Validation...
/home/ucadmin/UC-1/Unicorn-Amanuensis/whisperx/npu/npu_optimization/mel_kernels/build/mel_int8_final.xclbin: AMD/Xilinx accelerator AXLF (xclbin) file, 6753 bytes, created Tue Oct 28 01:00:31 2025, uuid ce78ce68-f106-fc35-fca5-5bd60eea508d, 7 sections

XRT Build Version: 2.20.0 (HEAD)
       Build Date: 2025-10-08 06:49:15
          Hash ID: 9b916190ad2865a7e7e497155c66b3b4940f0add
------------------------------------------------------------------------------
Warning: The option '--output' has not been specified. All operations will    
         be done in memory with the exception of the '--dump-section' command.
------------------------------------------------------------------------------
Reading xclbin file into memory.  File: /home/ucadmin/UC-1/Unicorn-Amanuensis/whisperx/npu/npu_optimization/mel_kernels/build/mel_int8_final.xclbin

==============================================================================
XRT Build Version: 2.20.0 (HEAD)
       Build Date: 2025-10-08 06:49:15
          Hash ID: 9b916190ad2865a7e7e497155c66b3b4940f0add
==============================================================================
The BUILD_METADATA section is not present. Reports will be limited.
==============================================================================
xclbin Information
------------------
   Generated by:           <unknown>
   Version:                2.20.0
   Kernels:                <unknown>
   Signature:              
   Content:                
   UUID (xclbin):          ce78ce68-f106-fc35-fca5-5bd60eea508d
   Sections:               MEM_TOPOLOGY, AIE_PARTITION, EMBEDDED_METADATA, 
                           IP_LAYOUT, CONNECTIVITY, GROUP_CONNECTIVITY, 
                           GROUP_TOPOLOGY
==============================================================================
Hardware Platform (Shell) Information
-------------------------------------
   Platform VBNV:          <not defined>
   Static UUID:            00000000-0000-0000-0000-000000000000
   Feature ROM TimeStamp:  0

Scalable Clocks
---------------
   No scalable clock data available.

System Clocks
------
   No system clock data available.

Memory Configuration
--------------------
   Name:         HOST
   Index:        0
   Type:         MEM_DRAM
   Base Address: 0x4000000
   Address Size: 0x1000000000
   Bank Used:    Yes

======================================================================
✅ MEL INT8 KERNEL BUILD COMPLETE!
======================================================================

Generated Files:
  - mel_physical.mlir      : Physical MLIR with tile assignments
  - mel_insts.bin          : NPU runtime instructions
  - mel_aie_cdo_*.bin      : Configuration data objects
  - mel_int8.pdi           : Platform device image (executable)
  - mel_int8_final.xclbin  : Complete NPU kernel package

Next: Test loading on NPU
  python3 << 'PYTEST'
import sys
sys.path.insert(0, '/opt/xilinx/xrt/python')
import pyxrt as xrt

device = xrt.device(0)
xclbin_obj = xrt.xclbin('build/mel_int8_final.xclbin')
uuid = xclbin_obj.get_uuid()
device.register_xclbin(xclbin_obj)
hw_ctx = xrt.hw_context(device, uuid)
print('✅ MEL INT8 kernel loaded on NPU!')
PYTEST

